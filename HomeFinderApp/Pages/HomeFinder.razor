@using HomeFinderApp.Services
@using HomeFinderApp.Models
@page "/"
@inject IHomeSearchService HomeSearchService

<h1>MS Build Demo - 2025</h1>
<h5>Azure LLM Functions with Elasticsearch for smarter query experiences</h5>

<textarea @bind="Query" class="form-control" placeholder="e.g., within 20 miles of Disney World..." rows="4"></textarea>
<button class="btn btn-primary mt-2" @onclick="OnSearch" disabled="@IsLoading">
    @(IsLoading ? "Searching‚Ä¶" : "Find Homes")
</button>

@if (ErrorMessage is not null)
{
    <div class="alert alert-danger mt-3">@ErrorMessage</div>
}
else if (Results?.Any() == true)
{
    <div class="mt-4">
        @foreach (var home in Results)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">@home.Title</h5>
                    <p>
                        <span>üè† <strong>Price:</strong> $@home.HomePrice</span><br />
                        <span>üõè <strong>Bedrooms:</strong> @home.Bedrooms</span><br />
                        <span>üõÅ <strong>Bathrooms:</strong> @home.Bathrooms</span><br />
                        <span>üìê <strong>Sq Ft:</strong> @home.SquareFootage</span><br />
                        <span>üí∞ <strong>Tax:</strong> $@home.AnnualTax</span><br />
                        <span>üßæ <strong>Maintenance:</strong> $@home.MaintenanceFee</span><br />
                        <span>‚ú® <strong>Property Description:</strong> @home.PropertyDescription</span>
                    </p>
                    @if (home.Features.Any())
                    {
                        <div>
                            <strong>‚ú® Features:</strong>
                            <div class="row">
                                @foreach (var feat in home.Features)
                                {
                                    <div class="col-6 col-md-3">
                                        <span class="badge bg-light text-dark">@feat</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
else if (Results is not null && !Results.Any())
{
    <div class="alert alert-warning mt-3">No results found. Please try a different query.</div>
}

@code {
    private string Query { get; set; } = "";
    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }
    private List<HomeFinderApp.Models.HomeResult>? Results { get; set; }

    private async Task OnSearch()
    {
        ErrorMessage = null;
        Results = null;
        if (string.IsNullOrWhiteSpace(Query))
        {
            ErrorMessage = "Please enter a search query.";
            return;
        }

        try
        {
            IsLoading = true;
            Results = await HomeSearchService.LLMSearchWithTools(Query);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }
}